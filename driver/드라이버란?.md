# 들어가기 앞서
엔드 포인드 보안 솔루션 개발자를 꿈꾸게 되면서 <b>안티 바이러스</b>(한국에서는 주로 백신)나 <b>EDR</b>(Endpoint Detection and Response)과 같은 제품들이 어떻게 동작하는지 정말 많이 궁금했었다.

그래서 구글링을 통해 인터넷 상의 자료나 기타 논문 등등을 찾다보니 자주 발견하게 되는 것이 바로 <ins>드라이버</ins>였다. 처음에는 '드라이버? 그거 그냥 하드웨어 제어하기 위한 소프트웨어 
아니야? 실제 하드웨어를 관리하면서 어떻게(?) 하는 건가?...'하고 의문을 품었다. 그도 그럴 것이 보통 드라이버라고 하면 앞에 '장치(device)'라는 말이 대부분 따라와 장치 드라이버(device driver)라고 
불리기도 하며 나처럼 관심이 없던 사람들은 그 정도로만 얕게 알고 있기 때문이다.

그래서 드라이버에 대한 정확한 정의와 역할을 찾다가 [MSDN](https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/what-is-a-driver-)에서 가려웠던 부분을 시원하게 긁어주는 글을 찾게 되어 이에 대한 내용을 정리하기로 하였다.  
~~(역시 공식문서 짱)~~

# 드라이버의 기본적인 정의
일반적으로 인터넷에서 드라이버에 대한 정의를 찾으면 다음과 같은 식으로 정의하는 것이 대부분이다.

> 특정 하드웨어나 장치를 제어하기 위한 커널의 일부분으로 동작하는 프로그램 <sup>[1]</sup>

이것이 우리가 알고있는 기본적인 정의이다. 아주 조금만 더 정확하게 설명하자면 `운영체제와 장치가 서로 통신할 수 있도록 하는 소프트웨어 구성 요소`를 `드라이버`라고 한다.

<p align="center">
<img alt="드라이버의 기본적 정의 그림" src="https://user-images.githubusercontent.com/77680436/125152829-78999680-e18a-11eb-8cb5-f629fa87a436.png"/>
</p>

위의 그림은 MSDN에서 드라이버의 가장 기본적인 정의를 설명하기 위한 그림이다. 위의 그림에서 드라이버는 장치에서 데이터를 가져온 후 데이터를 운영체제로 반환하고 
운영체제는 이를 애플리케이션으로 반환한다. 이처럼 운영체제와 장치 간의 중간 다리를 수행하는 소프트웨어를 일반적으로 드라이버라고 한다.

# 드라이버의 확장된 정의
보통의 경우 위와 같이 드라이버에 대한 기본적인 정의만 알고 있을 것 같다. 
하지만 나처럼 드라이버에 대해 조금만 더 깊게 찾아보기만 해도 위와 같은 정의는 어딘가 많이 부족하다는 것을 알게 된다. 실제로 MSDN의 글에서도 가장 첫 문장은 다음과 같다.

> It is challenging to give a single precise definition for the term driver.

드라이버에 대한 정확한 하나의 정의를 내리는 것은 어렵다고 하고 있다. 그러면서 어떤 부분들이 지나치게 단순화되어 있었는지 설명해주고 있는데, 그 중에서 가장 핵심은 다음이라고 생각한다.

> Not all drivers communicate directly with a device.

모든 드라이버가 장치와 직접 통신하는 것은 아니라고 하고 있다. 그렇다. 그동안 내가 궁금하고 의문을 품었던 보안 제품들의 드라이버는 바로 이 영역인 것이다.

드라이버의 기본적 정의에 대한 그림에서는 운영체제와 장치를 연결한 드라이버만을 단순하게 표현하였지만 실제로는 다음과 같이 여러 드라이버가 스택에 계층화되어 있는 경우가 대부분이다.

<p align="center">
<img alt="드라이버의 확장된 정의 그림" src="https://user-images.githubusercontent.com/77680436/125153238-52c1c100-e18d-11eb-866a-6bbd3f2b07b7.png"/>
</p>

이때 그림의 중간에 있는 드라이버는 요청을 검증하거나 조작하고 더 낮은 드라이버에 전달할 뿐 장치와 직접 통신하지 않는다. 즉 쉽게 말해 보조 처리를 수행하는 것이다. 
이러한 보조 처리를 수행하는 드라이버를 보통 `filter driver`라고 하며 장치와 직접 통신하는 드라이버를 `function driver`라고 한다.

# 소프트웨어 드라이버
드라이버의 확장된 정의를 통해서 필터 드라이버라는 것을 배웠다. 하지만 MSDN을 살펴보면 드라이버에 대한 설명이 아직 부족하다고 하고 있다.

필터 드라이버는 장치와 직접적으로 연결이 된 것은 아니지만 간접적으로나마 하드웨어 장치와 연결되어 있다. 하지만 하드웨어 장치와는 전혀 상관이 없는, 전혀 연결되지 않은 드라이버도 존재한다.

예를 들어 운영체제의 자료구조와 같은 데이터는 유저 모드에서는 접근할 수 없고, 커널 모드에서만 접근할 수 있다. 
우리는 이러한 데이터에 접근하기 위하여 일반적으로 유저 모드에서의 인터페이스를 통해서 접근을 요청한다. 그러면 커널 모드의 프로그램이 사용자의 요청을 듣고 대신 이를 처리하는 방식으로 진행된다.
이때 보호된 데이터에 접근하기 위해 커널 모드에서 실행되는 구성요소를 `software driver`라고 한다.

<p align="center">
<img alt="소프트웨어 드라이버" src="https://user-images.githubusercontent.com/77680436/125153716-a84b9d00-e190-11eb-99c9-322627eff3ae.png"/>
</p>

다시 한 번 말하지만 소프트웨어 드라이버는 하드웨어 장치와는 연결되어 있지 않다.

# 마무리하며
사실 아직 언급하지 않은 버스 드라이버가 남아있지만 궁금하다면 이는 [MSDN의 내용](https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/what-is-a-driver-#additional-notes)을 참고하길 바란다.

보안 솔루션 제품들에서 사용되는 드라이버는 주로 필터 드라이버이다. 실제로 등록된 필터 드라이버를 확인하는 명령어를 통해 확인해보면 다음과 같이 V3의 필터 드라이버가 등록되어 있는 것을 
확인할 수 있다.

<p align="center">
<img alt="소프트웨어 드라이버" src="https://user-images.githubusercontent.com/77680436/125154212-e72f2200-e193-11eb-84d5-316ee505ddf3.png"/>
</p>

필터 드라이버의 경우 보안 제품에서는 주로 실시간 검사나 행위 감지 및 차단 등을 위해 사용하며, 추후 얘기하겠지만 최근에는 이러한 필터 드라이버들은 `미니필터 드라이버(minifilter driver)` 형태로 구현된다. 
따라서 이후 작성하게 될 정리글들은 대부분 미니필터 드라이버에 초점이 맞춰질 예정이다.

추가적으로 드라이버에 대해서, 특히 보안 제품에서 사용하는 방식에 대해서 조사하다보니 자연스럽게 왜 보안에서는 C/C++을 필요로 하는지 이해가 가게된 계기가 되기도 했다.
